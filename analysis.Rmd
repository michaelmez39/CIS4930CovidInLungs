---
title: "R Notebook"
output:
  word_document: default
  html_notebook: default
---
**include dependencies**
```{r, echo=FALSE}
library(data.table)
library(dplyr)
library(purrr)
library(DESeq2)
library(ComplexHeatmap)
library(clusterProfiler)
library(DOSE)
library(org.Hs.eg.db)
```

#### Data Loading
*Only use relevant columns*
```{r}
infected_raw <- fread(file="data/GSE162323_slam_inf_params.txt", check.names=TRUE)
uninfected_raw <- fread("data/GSE162323_slam_uninf_params.txt", check.names=TRUE)
infected_1 = infected_raw[,c(1, 3:8)]
uninfected_1 = uninfected_raw[,c(1, 3:8)]
```

*Remove duplicate rows with median and merge uninfected and infected gene expression datasets*
```{r}
infected_dedup <- infected_1 %>%
  group_by(gene.symbol) %>%
  summarize(
    one.hour.inf = as.integer(median(X1h.4sU.Readcount, na.rm=TRUE)),
    two.hour.inf = as.integer(median(X2h.4sU.rep1.Readcount)),
    three.hour.inf = as.integer(median(X3h.4sU.Readcount)),
    four.hour.inf = as.integer(median(X4h.4sU.Readcount))
    )

uninfected_dedup <- uninfected_1 %>%
  group_by(gene.symbol) %>%
  summarize(
    one.hour.uninf = as.integer(median(X1h.4sU.Readcount, na.rm=TRUE)),
    two.hour.uninf = as.integer(median(X2h.4sU.rep2.Readcount)),
    three.hour.uninf = as.integer(median(X3h.4sU.Readcount)),
    four.hour.uninf = as.integer(median(X4h.4sU.Readcount))
    )

cts_merged <- merge(x=infected_dedup, y=uninfected_dedup, by="gene.symbol")
cts <- cts_merged[,-1]
rownames(cts) <- cts_merged[,1]
print(cts)
```
### PCA Plot
*Coldata*
```{r}
coldata <- as.data.frame(names(cts))
coldata$condition <- c("infected", "infected", "infected", "infected", "uninfected", "uninfected", "uninfected", "uninfected")
coldata$batch <- c("one", "two", "three", "four", "one", "two", "three", "four")
```

*Gene Expression Matrix*
```{r}
dds <- DESeqDataSetFromMatrix(countData = cts,
                              colData = coldata,
                              design = ~ condition + batch)
dds <- DESeq(dds) #this is doing a lot of number crunching
res <- results(dds)
vsd <- vst(dds, blind=FALSE)
head(res)
```
*PCA Plot TODO: Correct axis (infected vs uninfected)*
```{R}
plotPCA(vsd, intgroup=c("condition"))
```
#In this plot, we plotted rlog transformed data to check results. To compare the infected and uninfected genes, we plotted one with plotPCA() function. An interesting result is that the plot produced huge and distinct differences between infected and uninfected genes. 

### Volcano Plot
#### Some Extra Analysis
```{r}
set.seed(9823249)
deseq_df <- res |>
  as.data.frame() |>
  tibble::rownames_to_column("Gene") |>
  dplyr::mutate(threshold = padj < 0.05) |>
  arrange(desc(log2FoldChange))

head(deseq_df, n=10)
```
```{r}
volcano_plot <- EnhancedVolcano::EnhancedVolcano(
  deseq_df,
  lab = deseq_df$Gene,
  x = "log2FoldChange",
  y = "padj",
  pCutoff = 0.01
)
volcano_plot
```
### clustProfiler GO
```{r}
geneList <- deseq_df[,3]
names(geneList) = deseq_df[,1]
go_res <- gseGO(
  geneList = sort(geneList, decreasing = TRUE),
  OrgDb = org.Hs.eg.db,
  ont = "BP",

  keyType = 'SYMBOL',
  pvalueCutoff = 0.05,
  verbose = FALSE
)

head(go_res, n=10)

```
#### Dot Plot
```{r}
dotplot(go_res, showCategory=10)
```
#### CNet Plot
```{r}
cnetplot(go_res, node_label="category", 
        cex_label_category = 1.2) 
```

For the gene ontology using clusterProfiler we looked at the biological processes domain. Many of the genes that are being expressed are related to the immune response.

### clustProfiler Disease Ontology


```{r}
geneListEntrez <- deseq_df[,3]
names(geneListEntrez) <- as.character(deseq_df[,1])
y <- gseDO(sort(geneListEntrez, decreasing = TRUE),
           pvalueCutoff  = 0.05,
           pAdjustMethod = "BH",
           keyType = 'SYMBOL',
           verbose       = FALSE
           )

```
```{r}
dotplot(y)
```
